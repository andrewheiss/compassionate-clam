---
title: Model details
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.align = "center", fig.retina = 3,
                      fig.width = 6, fig.height = (6 * 0.618),
                      out.width = "80%", collapse = TRUE,
                      dev = "png", dev.args = list(type = "cairo-png"))

options(digits = 3, width = 120,
        dplyr.summarise.inform = FALSE,
        knitr.kable.NA = "")
```

```{r load-libraries, warning=FALSE, message=FALSE}
library(tidyverse)
library(targets)
library(brms)
library(marginaleffects)
library(tidybayes)
library(ggdist)
library(patchwork)
library(scales)
library(glue)
library(gt)
library(gtExtras)

# Generated via random.org
set.seed(196491)

# Load targets
tar_load(ongo)
tar_load(c(m_full_ordbeta, m_full_interaction_ordbeta))
invisible(list2env(tar_read(graphic_functions), .GlobalEnv))
invisible(list2env(tar_read(table_functions), .GlobalEnv))
```

```{r calculate-model-times}
models <- tribble(
  ~model_name, ~model,
  "Full model", m_full_ordbeta,
  "Full model with `local_connect * years_since_law` interaction", m_full_interaction_ordbeta,
) |> 
  mutate(duration = map(model, ~{
    .$fit |> 
      rstan::get_elapsed_time() |> 
      as_tibble() |> 
      summarize(total = as.duration(max(warmup + sample)))
  })) |> 
  select(-model) |> 
  unnest(duration)

dur <- as.period(as.duration(sum(models$total)))

total_run_time <- glue(
  "{hours} hours, {minutes} minutes, and {seconds} seconds",
  hours = hour(dur), minutes = minute(dur), seconds = round(second(dur), 0)
)
```

We ran these models on a 2021 M1 MacBook Pro with 32 GB of RAM, with 4 MCMC chains spread across 8 cores, with two CPU threads per chain, using Stan through brms through cmdstanr. 

In total, it took `r total_run_time` to run everything.

```{r mcmc-duration-table}
models |> 
  gt() |> 
  tab_footnote(
    footnote = "Duration of the longest-running MCMC chain",
    locations = cells_column_labels(columns = total)
  ) |> 
  cols_label(
    model_name = "Model",
    total = "Total time"
  ) |> 
  cols_align(
    align = "left",
    columns = everything()
  ) |>
  fmt_markdown(columns = model_name) |> 
  grand_summary_rows(
    columns = c(total),
    fns = list(`Overall total` = ~as.duration(sum(.)))
  ) |> 
  opt_footnote_marks(marks = "standard") |> 
  opt_horizontal_padding(3) |> 
  opts_theme()
```
